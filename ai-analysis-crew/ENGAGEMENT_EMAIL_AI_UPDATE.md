# Engagement Email AI Update

## Overview
The reengagement email system has been upgraded to use AI-generated content instead of hardcoded templates. All generated emails are now stored in the database for admin reference and analytics.

## Changes Made

### 1. AI-Powered Email Content Generation
- **New File**: `app/ai_email_generator.py`
  - Uses OpenAI GPT-4o to generate complete, personalized email content
  - Creates unique subject lines, HTML content, and plain text versions
  - Includes proper email structure with hero and inline images
  - Maintains all app links (dashboard, upload, help, contact, settings)

### 2. Database Storage for Engagement Emails
- **New File**: `app/engagement_email_storage.py`
  - Stores all generated emails in Supabase database
  - Tracks email status (generated, sent, failed, bounced)
  - Records engagement metrics (opened, clicked)
  - Stores all links and metadata for admin reference

### 3. Database Migration
- **New File**: `database-engagement-emails.sql`
  - Creates `engagement_emails` table in Supabase
  - Includes proper indexes for performance
  - Row Level Security (RLS) policies for admin access
  - Stores complete email content, images, links, and metadata

### 4. Updated Email Sending Function
- **Modified**: `app/cron_reminders.py`
  - Generates hero image (top of email)
  - Generates inline image (middle of email content)
  - Uses AI to generate complete email content
  - Stores email in database before sending
  - Updates email status after sending
  - Falls back to basic template if AI generation fails

## Database Setup

### Step 1: Apply Database Migration
Run the SQL migration in your Supabase SQL Editor:

```sql
-- File: database-engagement-emails.sql
-- Execute this in Supabase SQL Editor
```

This creates the `engagement_emails` table with:
- Email content (subject, HTML, text)
- Image URLs (hero and inline)
- Links (dashboard, upload, help, contact, settings)
- Status tracking (generated, sent, failed, opened, clicked)
- Timestamps and metadata

### Step 2: Verify Table Creation
Check that the table was created:
```sql
SELECT * FROM engagement_emails LIMIT 1;
```

## Features

### AI-Generated Content
- **Subject Lines**: Unique, personalized subject lines generated by AI
- **HTML Content**: Complete, professional HTML emails with:
  - Hero image at the top
  - Inline image in the content
  - Personalized greeting
  - Compelling value proposition
  - Key benefits in bullet points
  - Strong call-to-action buttons
  - Professional footer with links
- **Plain Text**: Fallback text version for email clients

### Image Generation
- **Hero Image**: Generated using Hugging Face FLUX.1-dev model
- **Inline Image**: Second unique image for content variety
- **Theme-Based**: Images generated based on random themes (industrial, parts, maintenance, technology)
- **Storage**: Images stored in Supabase Storage at `email-images/{theme}/`
- **Fallback**: Uses Unsplash images if AI generation fails

### Database Storage
Every email is stored with:
- Complete HTML and text content
- All image URLs
- All app links
- AI model used (gpt-4o)
- Generation timestamp
- Send status and timestamps
- Engagement metrics (opened, clicked)

## Admin Access

Admins can query engagement emails:
```sql
-- View all sent emails
SELECT * FROM engagement_emails WHERE status = 'sent' ORDER BY sent_at DESC;

-- View email engagement metrics
SELECT 
  COUNT(*) as total_sent,
  SUM(CASE WHEN opened THEN 1 ELSE 0 END) as total_opened,
  SUM(CASE WHEN clicked THEN 1 ELSE 0 END) as total_clicked,
  ROUND(100.0 * SUM(CASE WHEN opened THEN 1 ELSE 0 END) / COUNT(*), 2) as open_rate,
  ROUND(100.0 * SUM(CASE WHEN clicked THEN 1 ELSE 0 END) / COUNT(*), 2) as click_rate
FROM engagement_emails
WHERE status = 'sent';
```

## Environment Variables Required

Ensure these are set in `.env`:
```
OPENAI_API_KEY=your_openai_key
HF_TOKEN=your_huggingface_token
HF_IMAGE_MODEL=black-forest-labs/FLUX.1-dev
HF_PROVIDER=nebius
SUPABASE_URL=your_supabase_url
SUPABASE_SERVICE_KEY=your_service_key
SUPABASE_BUCKET_NAME=sparefinder
```

## Testing

Test the new system:
```bash
# Test email generation and storage
curl -X POST https://aiagent-sparefinder-org.onrender.com/test/reengagement-email \
  -H "Content-Type: application/json" \
  -d '{"email": "test@example.com", "user_name": "Test User"}'
```

## Fallback Behavior

If AI generation fails:
1. System falls back to basic HTML template
2. Still stores email in database
3. Still sends email via SMTP or email service
4. Logs error for debugging

## Benefits

1. **Unique Content**: Every email is different, personalized by AI
2. **Better Engagement**: AI-generated content is more compelling
3. **Admin Insights**: All emails stored for analysis and reference
4. **Image Variety**: Two unique images per email for visual appeal
5. **Link Preservation**: All app links maintained in database
6. **Analytics Ready**: Database structure supports engagement tracking

